<div class="widget__container">
    {% assign comics = site.prismic.collections.comics %}
    {% for i in (0..3) %}{% if comics[i] %}
    {% assign url = '/comics/' | append: comics[i].uid | append: '/' %}
    <div class="widget" data-url="{{ url }}" data-slug="{{ comics[i].uid }}" onclick="onClick(this, '{{ url }}', '{{ comics[i].uid }}');">
        <div class="widget__text">
            <a class="widget__title">{{ comics[i].fragments.title.text }}</a>
        </div>
    </div>
    {% endif %}{% endfor %}
    <div class="widget">
        <div class="widget__text">
            <span class="widget__title">Today's Date:</span>
            <span id="widget-date"></span>
        </div>
    </div>
    <div class="widget">
        <img id="widget-weather-icon" style="height: 100%; margin-right: 16px;">
        <div class="widget__text">
            <span class="widget__title">Weather (<span id="widget-weather-location"></span>):</span>
            <span id="widget-weather"></span>
        </div>
    </div>
</div>

<script type="text/javascript">
    (function() {
        $('#widget-date').text(new Date().toDateString());

        let bindWeather = function(weather) {
            $('#widget-weather').text(weather.description);
            $('#widget-weather-icon').attr("src", weather.icon);
            $("#widget-weather-location").text(weather.location);
        };

        let weather = JSON.parse(localStorage.getItem("widget/weather")) || {};
        if (weather && Date.now() - weather.timestamp < 7200000) {
            bindWeather(weather);
        } else {
            $.get('http://ip-api.com/json/', function(response) {
                weather.location = response.city + ', ' + response.region;

                if (response.lat < 0)
                    response.lat += 360;
                if (response.lon < 0)
                    response.lon += 360;

                $.get('https://api.weatherbit.io/v2.0/current?lat=' + response.lat + '&lon=' + response.lon + '&key=e46ee7b526e14cfaa8402cb037e9efa5', function(weatherResponse) {
                    weather.timestamp = Date.now();
                    weather.description = weatherResponse.data[0].weather.description;
                    weather.icon = "https://www.weatherbit.io/static/img/icons/" + weatherResponse.data[0].weather.icon + ".png";

                    localStorage.setItem("widget/weather", JSON.stringify(weather));
                    bindWeather(weather);
                });
            });
        }
    })();
</script>
